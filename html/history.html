<html lang="en-vi">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="Style.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
    </script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script lang="javascript" src="dist/xlsx.full.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/table-to-json@1.0.0/lib/jquery.tabletojson.min.js" integrity="sha256-H8xrCe0tZFi/C2CgxkmiGksqVaxhW0PFcUKZJZo1yNU=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.0/jspdf.umd.min.js"></script>

    <script src="Script.js"></script>

    <title>Hệ Thống Vườn Thông Minh</title>
</head>

<body>
    <!-- nav bar -->
    <header class="header">
        <div class="logo-header">
            <a href="#" class="logo">
                <img style="height: 130px;" src="Image/Logo.jfif" alt="" srcset="">
            </a>
            <div class="header-text">
                <h2>HỆ THỐNG GIÁM SÁT VƯỜN THÔNG MINH</h1>

            </div>
        </div>
        <nav class="nav-bar">
            <!-- <a href="#home">Trang chủ</a> -->
            <a href="begin.html">HOME</a>
            <a href="System.html">HỆ THỐNG</a>
            <a href="#history">LỊCH SỬ</a>
            <a id="if" href="index.html">ĐĂNG XUẤT</a>
        </nav>
    </header>
        <!-- end nav bar -->
        <div class="form-ctrl">
            <div class="his-ctrl" >
                <input id="picker" class="datepicker" type="date" placeholder="Select Date">
                <button id="search" type="butone" class="btn btn-secondary btn-cover" >Search</button>
                <button id="today" type="butone" class="btn btn-secondary btn-cover" >Today</button>
                <button id="all" type="butone" class="btn btn-secondary btn-cover" >All</button>

                <span class="btn-group dropend">
                    <button type="button" class="btn btn-warning btn-lg dropdown-toggle btn-cover1" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        Report</button>
                    <ul class="dropdown-menu  dropdown-menu-dark">
                        <li><a onclick="exportToExcel('Bản báo cáo', 'Users', 'table')"class="dropdown-item" href="#">Excel</a></li>
                        <li><a  id="btnpdf" onclick="expdf()"  class="dropdown-item" href="#">PDF</a></li>
                    </ul>
                </span>
            </div>
        </div>
        <div id="report" class="container mt-3 table-responsive" Style="width: 100%; height: 800px;">
            <table id="table" class="table  table-borderless table-cover table-striped table-hover table-bordered ">
                <thead class="thead head table-dark">
                    <th>Date</th>
                    <th>Time</th>
                    <th>Mode</th>
                    <th>Ánh sáng (lux)</th>
                    <th>Nhiệt độ (&#8451;)</th>
                    <th>Độ ẩm (%)</th>
                    <th>Thời tiết</th>
                    <th>Máy bơm</th>
                    <th>Motor</th>
                    <th>Quạt</th>
                    <th>Chiếu sáng</th>
                    <th>Sưởi</th>
                </thead>
                <tbody class="tbody table-secondary" id="tbody1"></tbody>
            </table>
        </div>

        <script type="module">
            flatpickr("input[type=date]", {
                dateFormat: "d-m-Y",
            });
// Excel



// End Excels
            import {
                initializeApp
            } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
            import {
            getDatabase,
            ref,
            set,
            onValue
            } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
            import {
                getAuth
            } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
            import {
                getAnalytics
            } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";

            const firebaseConfig = {
                apiKey: "AIzaSyCHJuYM58Zlpa0r98AgAd4LhJHAIyouWLA",
                authDomain: "scada-a6149.firebaseapp.com",
                databaseURL: "https://scada-a6149-default-rtdb.firebaseio.com",
                projectId: "scada-a6149",
                storageBucket: "scada-a6149.appspot.com",
                messagingSenderId: "1022268780215",
                appId: "1:1022268780215:web:b68855223e34b816002732",
                measurementId: "G-CGQ7ZFND4S"
            };
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const database = getDatabase(app);
            const auth = getAuth(app);

            // FILLING THE TABBLE

            var tbody = document.getElementById('tbody1');
        function AddItemToTable(date,time,mode,light,temp,soil,wheather,pump, motor, fan, lamp, warm) {
        
                let trow = document.createElement('tr');
                let td0 = document.createElement('td');
                let td1 = document.createElement('td');
                let td2 = document.createElement('td');
                let td3 = document.createElement('td');
                let td4 = document.createElement('td');
                let td5 = document.createElement('td');
                let td6 = document.createElement('td');
                let td7 = document.createElement('td');
                let td8 = document.createElement('td');
                let td9 = document.createElement('td');
                let td10 = document.createElement('td');
                let td11 = document.createElement('td');

                td0.innerHTML = date;
                td1.innerHTML = time;
                td2.innerHTML = mode;
                td3.innerHTML = light;
                td4.innerHTML = temp;
                td5.innerHTML = soil;   
                td6.innerHTML = wheather;
                td7.innerHTML = pump;
                td8.innerHTML = motor;
                td9.innerHTML = fan;
                td10.innerHTML = lamp;
                td11.innerHTML = warm;

                trow.appendChild(td0);
                trow.appendChild(td1);
                trow.appendChild(td2);
                trow.appendChild(td3);
                trow.appendChild(td4);
                trow.appendChild(td5);
                trow.appendChild(td6);
                trow.appendChild(td7);
                trow.appendChild(td8);
                trow.appendChild(td9);
                trow.appendChild(td10);
                trow.appendChild(td11);

                tbody.appendChild(trow);
            }

            var rdtdate=new Array();
            var rtime=new Array();
            let len=0;
            var data=new Array();
            let date;
    setInterval(()=>{
        rdtdate=[];
        const read=ref(database,'/History/');
        onValue(read,(snapshot)=>{
        snapshot.forEach((e)=>{
        rdtdate=Object.keys(snapshot.val()) ;
        })
        });
    },1000);

    //Hàm hiển thị lịch sử lên table
function Load(){
        var read1=[];
        var read2=[];
        var rain;
        rtime=[];
        for(var i=0;i<rdtdate.length;i++){
            read1=ref(database,'/History/'+rdtdate[i]);
            onValue(read1,(snapshot1)=>{
            len=Object.keys(snapshot1.val()).length;
            for(var j=0;j<len;j++){ 
                rtime.push(Object.keys(snapshot1.val())[j]); 
            } });
            
            for(var k=0;k<rtime.length;k++)
            { 
                read2=ref(database,'/History/'+rdtdate[i]+'/'+rtime[k]); 
                onValue(read2,(snapshot2)=>{
                    if(snapshot2.val().Rain=="r1"){
                    rain="Rain";
                    }
                    else {
                    rain="Not Rain";
                    }
                AddItemToTable(rdtdate[i],rtime[k],snapshot2.val().Mode,snapshot2.val().Light,snapshot2.val().Temperature,snapshot2.val().Soil,rain,snapshot2.val().Pump,snapshot2.val().Motor,snapshot2.val().Fan,snapshot2.val().Lamp,snapshot2.val().Warm);
                });
                }
        }
}
//Làm mới table
function formatTable(){
    var table = document.getElementById('table');
        var rowCount = table.rows.length;
        for (var i = 1; i < rowCount; i++) {
            table.deleteRow(1); } 
}
all.addEventListener('click',(e)=>{
    formatTable();
    Load();

});
//Hiển thị lịch sử ở ngày hiện tại
today.addEventListener('click',(e)=>{
    const monthNames = ["01", "02", "03", "04", "05", "06",
        "07", "08", "09", "10", "11", "12"];
    const dateObj = new Date();
    const month = monthNames[dateObj.getMonth()];
    const day = String(dateObj.getDate()).padStart(2, '0');
    const year = dateObj.getFullYear();
    const output = day  + '-'+ month  + '-' + year;
    formatTable();
    var read1=[];
    var read2=[];
    var rain;
    rtime=[];
    read1=ref(database,'/History/'+output);
    onValue(read1,(snapshot1)=>{
    len=Object.keys(snapshot1.val()).length;
    for(var j=0;j<len;j++){ 
        rtime.push(Object.keys(snapshot1.val())[j]); 
    } });
    for(var k=0;k<rtime.length;k++)
    { 
        read2=ref(database,'/History/'+output+'/'+rtime[k]); 
        onValue(read2,(snapshot2)=>{
            if(snapshot2.val().Rain=="r1"){
            rain="Rain";
            }
            else{
            rain="Not Rain";
            }
            AddItemToTable(output,rtime[k],snapshot2.val().Mode,snapshot2.val().Light,snapshot2.val().Temperature,snapshot2.val().Soil,rain,snapshot2.val().Pump,snapshot2.val().Motor,snapshot2.val().Fan,snapshot2.val().Lamp,snapshot2.val().Warm);
        });
    }
}) ;  

//Tìm kiếm lịch sử theo ngày
search.addEventListener('click',(e)=>{
    
    var sldate=document.getElementById('picker').value;
    if(sldate==""){
    alert('Please select a date');
    }
    else{
        formatTable();
        var read1=[];
        var read2=[];
        var rain;
        rtime=[];
        read1=ref(database,'/History/'+sldate);
        onValue(read1,(snapshot1)=>{
        len=Object.keys(snapshot1.val()).length;
        for(var j=0;j<len;j++){ 
            rtime.push(Object.keys(snapshot1.val())[j]); 
        } });
        for(var k=0;k<rtime.length;k++)
        { 
            read2=ref(database,'/History/'+sldate+'/'+rtime[k]); 
            onValue(read2,(snapshot2)=>{
                if(snapshot2.val().Rain=="r1"){
                rain="Rain";
                }
                else{
                rain="Not Rain";
                }
                AddItemToTable(sldate,rtime[k],snapshot2.val().Mode,snapshot2.val().Light,snapshot2.val().Temperature,snapshot2.val().Soil,rain,snapshot2.val().Pump,snapshot2.val().Motor,snapshot2.val().Fan,snapshot2.val().Lamp,snapshot2.val().Warm);
            });
        }
    }

});
</script>

</body>